<div class="node" [class.waitingForJoin]="waitingForJoin">
  <div class="waitingForJoin" *ngIf="waitingForJoin" (click)="join()"></div>
  <header>
    <span id="{{ elementRef.nativeElement.id + '_join' }}"></span>
    <ng-content select="dragHandle"> </ng-content>
    <div class="options">
      @if (type !== 'distributor') {
        <label class="simulateButton options__addImage">
          <input
            type="file"
            id="image"
            name="image"
            accept="image/*"
            title="Delete node"
            (change)="onAddImage($event)"
          />
        </label>
      }
      <button
        title="Delete node"
        class="options__remove"
        (click)="onRemoveNode()"
      ></button>
    </div>
  </header>
  <main>
    @if (type === 'distributor') {
      <div *ngIf="conditions && conditions.length > 0" class="node__answers">
        <polo-condition
          *ngFor="let condition of conditions"
          id="{{ condition.id }}"
          [nodeId]="elementRef.nativeElement.id"
          [selectedRef]="condition.ref"
          [comparator]="condition.comparator"
          [value]="condition.value"
          (onRemoveCondition)="removeCondition($event)"
          (onWillJoin)="willJoin($event)"
        ></polo-condition>
      </div>
      <polo-condition
        id="{{
          'condition_' + elementRef.nativeElement.id.split('_')[1] + '_fallback'
        }}"
        [nodeId]="elementRef.nativeElement.id"
        [fallback]="true"
        (onRemoveCondition)="removeCondition($event)"
        (onWillJoin)="willJoin($event)"
      ></polo-condition>
    } @else if (type === 'end') {
      @if (image) {
        <img
          width="100%"
          [src]="
            'https://lsemostpqoguehpsbzgu.supabase.co/storage/v1/object/public/images/' +
            image
          "
        />
      }
      <textarea #textarea (change)="saveNodeText($event)">{{ text }}</textarea>
      <div class="node__linkoptions">
        <div class="node__linkoptions__header">
          <p class="node__linkoptions__header__title">External links</p>
          <button (click)="addExternalLink()">add</button>
        </div>
        <label class="node__linkoptions__link">
          @for (link of links | keyvalue; track $index) {
            <input
              (change)="updateLinks()"
              [(ngModel)]="links[$index].name"
              type="text"
              placeholder="Link text"
            /><input
              (change)="updateLinks()"
              [(ngModel)]="links[$index].url"
              type="text"
              placeholder="Link URL"
            />
          }
        </label>
      </div>
      <div class="node__shareoptions">
        <p class="node__shareoptions__title">Share options</p>
        <label class="node__shareoptions__option">
          <p>Custom shared text</p>
          <textarea
            (change)="updateSharedText()"
            [(ngModel)]="shareOptions.sharedText"
          >
          </textarea>
        </label>
        <label class="node__shareoptions__option--row">
          <p>Allow to share all decisions</p>
          <input disabled type="checkbox" />
        </label>
      </div>
    } @else {
      @if (image) {
        <div class="node__image">
          <img
            width="100%"
            [src]="
              'https://lsemostpqoguehpsbzgu.supabase.co/storage/v1/object/public/images/' +
              image
            "
          />
          <button
            title="Delete image"
            class="node__image__remove"
            (click)="removeNodeImage()"
          ></button>
        </div>
      }
      <textarea #textarea (change)="saveNodeText($event)">{{ text }}</textarea>
      <div *ngIf="answers && answers.length > 0" class="node__answers">
        <polo-answer
          *ngFor="let answer of answers"
          id="{{ answer.id }}"
          [nodeId]="elementRef.nativeElement.id"
          [text]="answer.text"
          (onRemoveAnswer)="removeAnswer($event)"
          (onWillJoin)="willJoin($event)"
        ></polo-answer>
      </div>
    }
  </main>
  <footer>
    <p>{{ elementRef.nativeElement.id }}</p>
    @if (type === 'distributor') {
      <button (click)="addCondition()">Add condition</button>
    } @else if (type === 'content') {
      <button (click)="addAnswer()">Add answer</button>
    }
  </footer>
</div>
